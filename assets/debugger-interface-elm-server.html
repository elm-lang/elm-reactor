<html>
<head>
</head>
<body style="background-color:rgb(255,255,255);">
  <div>
    <button class="largeButton" id="buttonRestart">Restart</button>
    <button class="largeButton" id="buttonPause">Pause</button>
    <div>
      <input type="checkbox" name="hotswap" id="hotswap" checked>
        <span id="hscheckbox"> Hotswap?</span>
    </div>
    <div>
      <p id="statusText"></p>
    </div>
    <input id="timeSlider" type=range value=0 step=1 min=0 max=0/>
  </div>
  <div id="watches">
  </div>
<style>
body {
  font-family: "Lucida Grande";
}

#hscheckbox {
  font-size: 12px;
}

#watches {
  padding-top: 6px;
}

#watches > div {
  padding-top: 10px;
  padding-bottom: 10px;
}

#statusText {
  padding-left:6px;
  font-size: 12px;
  display: inline;
}

#timeSlider {
  width: 100%;
}
</style>
<script>
if (!String.prototype.format) {
  String.prototype.format = function() {
  var args = arguments;
  return this.replace(/{(\d+)}/g, function(match, number) {
    return typeof args[number] != 'undefined'
    ? args[number]
    : match
    ;
  });
  };
}

var elmDebugger = {
  restart: function() {},
  pause: function() {},
  kontinue: function() {},
  getMaxSteps: function() { return 0; },
  stepTo: function(i) {},
  getPaused: function() { return false; },
  getHotSwapState: function() { return null; },
  watchTracker: { frames:[{}] }
};

function updateStatus() {
  if (elmDebugger.getPaused()) {
    statusText.textContent = "Event {0} of {1}".format(timeSlider.value, elmDebugger.getMaxSteps());
  }
  else {
    statusText.textContent = "{0} events".format(elmDebugger.getMaxSteps());
  }
}

function updateWatches() {
  while (watchesDiv.hasChildNodes()) {
    watchesDiv.removeChild(watchesDiv.lastChild);
  }
  var frame = elmDebugger.watchTracker.frames[timeSlider.value];
  for (var tag in frame) {
    var node = document.createElement('div');
    node.innerHTML = tag + ':<br><code>' + show(frame[tag]) + '</code><br>'
    watchesDiv.appendChild(node);
  }
}

var watchesDiv = document.getElementById("watches");
var statusText = document.getElementById("statusText");
var timeSlider = document.getElementById("timeSlider");
timeSlider.addEventListener('input',  slide);
timeSlider.addEventListener('change', slide);
function slide(e) {
  console.log("Time sliding");
  elmDebugger.stepTo(+timeSlider.value);
  updateStatus();
  updateWatches();
}

var paused = false;
var pauseButton = document.getElementById('buttonPause');
pauseButton.addEventListener('click', function(e) {
  if(paused) {
    elmDebugger.kontinue();
    refreshDebuggerUI();
    pauseButton.innerHTML = 'Pause';
  } else {
    elmDebugger.pause();
    refreshDebuggerUI();
    pauseButton.innerHTML = 'Continue';
  }
  paused = !paused;
});

document.getElementById('buttonRestart').addEventListener('click', function(e) {
  pauseButton.innerHTML = 'Pause';
  pauseButton.disabled = false;
  pauseButton.title = "";
  elmDebugger.restart();
  refreshDebuggerUI();
});

function refreshDebuggerUI() {
  updateStatus();
  updateWatches();
  timeSlider.max = elmDebugger.getMaxSteps();
  if (elmDebugger.getPaused()) {
    timeSlider.disabled = false;
  }
  else {
    timeSlider.disabled = true;
    timeSlider.value = timeSlider.max;
  }
}

var show;
function startDebugging(elmWindow) {
  elmDebugger = elmWindow.Elm.Debugger;
  show = elmWindow.Elm.String.make({}).show;
}

parent.window.addEventListener("message", function(e) {
  if (e.data == "elmDebuggerInit") {
    startDebugging(e.source);

    var filePath = top.output.Elm.Debugger.filename;
    // "/todo.html" => "todo.elm"
    filePath = filePath || top.location.pathname.substr(1).split(".")[0] + ".elm";
    var socketLocation = "ws://" + window.location.host + "/socket?file=" + filePath;
    var serverConnection = new WebSocket(socketLocation);
    serverConnection.onmessage = messageRoute;
  }
  else if (e.data == "elmNotify") {
    refreshDebuggerUI();
  }
}, false);


function messageRoute(event) {
      var hotSwapCheckbox = document.getElementById("hotswap");
      if(hotSwapCheckbox.checked) {
        hotSwap(event.data);
      }
    };

function hotSwap(raw) {
  var top = self.parent;
  var result = JSON.parse(raw);
  var js = result.success;
  if (js) {
      var error = top.output.document.getElementById('ErrorMessage');
      if (error) {
          error.parentNode.removeChild(error);
      }
      top.output.eval(js);
      var moduleStr = js.match(/(Elm\..+)\ =\ \1/)[1];
      var module = top.output.eval(moduleStr);
      if (top.output.Elm.Debugger) {
          var debuggerState = top.output.Elm.Debugger.getHotSwapState();
          if (top.output.runningElmModule) {
            top.output.runningElmModule.dispose();
          }
          top.output.Elm.Debugger.dispose();

          var wrappedModule = top.output.Elm.debuggerAttach(module, debuggerState);
          top.output.runningElmModule = top.output.Elm.fullscreen(wrappedModule);
      }
      else {
          top.output.runningElmModule =
              top.output.runningElmModule.swap(module);
      }
  }
}

</script>
</body>
</html>
